@page "/"
@page "/posts"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject IPostsService PostsService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthProvider

<h3>Posts</h3>

<AuthorizeView>
    <Authorized Context="auth">
        <h4>Create post</h4>

        <EditForm Model="_newPost" OnValidSubmit="CreatePostAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-2">
                <label>Title:</label><br />
                <InputText @bind-Value="_newPost.Title" />
            </div>

            <div class="mb-2">
                <label>Body:</label><br />
                <InputTextArea @bind-Value="_newPost.Body" />
            </div>

            <p>
                Creating post as:
                <strong>@auth.User.Identity?.Name</strong>
            </p>

            <button type="submit" class="btn btn-primary">
                Create
            </button>
        </EditForm>

        <hr />
    </Authorized>
    <NotAuthorized>
        <p>You must be logged in to create posts.</p>
        <hr />
    </NotAuthorized>
</AuthorizeView>

<h4>All posts</h4>

<input placeholder="Filter by title..."
       @bind="_filterTitle"
       @bind:event="oninput" />
<button @onclick="LoadPostsAsync" class="btn btn-secondary btn-sm ms-1">
    Search
</button>

@if (_posts is null)
{
    <p><em>Loading...</em></p>
}
else if (!_posts.Any())
{
    <p>No posts found.</p>
}
else
{
    <ul>
        @foreach (var p in _posts)
        {
            <li>
                <a @onclick="@(() => OpenPost(p.Id))">@p.Title</a>
                – by @p.Username
            </li>
        }
    </ul>
}

@code {
    private List<PostDto>? _posts;
    private string? _filterTitle;

    // IMPORTANT: set ALL required members here, so CS9035 goes away
    private CreatePostDto _newPost = new CreatePostDto
    {
        Title  = string.Empty,
        Body   = string.Empty,
        UserId = 0
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadPostsAsync();
    }

    private async Task LoadPostsAsync()
    {
        var data = await PostsService.GetAllAsync(_filterTitle);
        _posts = data.ToList();
    }

    private async Task CreatePostAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!(user.Identity?.IsAuthenticated ?? false))
            return;

        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (idClaim is null) return;
        if (!int.TryParse(idClaim.Value, out var userId)) return;

        // 👇 Logged-in user id goes here
        _newPost.UserId = userId;

        await PostsService.CreateAsync(_newPost);

        // reset with all required members set again
        _newPost = new CreatePostDto
        {
            Title  = string.Empty,
            Body   = string.Empty,
            UserId = 0
        };

        await LoadPostsAsync();
    }

    private void OpenPost(int id)
    {
        Nav.NavigateTo($"/posts/{id}");
    }
}
